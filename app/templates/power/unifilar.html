{% extends "base.html" %}
{% block title %}Unifilar PyPSA{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.css">
<style>
#cy{ height: 560px; background:#fff; border-radius:12px; border:1px solid #eee; }
.legend span{ display:inline-block; width:14px; height:14px; border-radius:3px; margin-right:6px; vertical-align:middle; }
.legend .ok{ background:#2bb673; } .legend .warn{ background:#ff9800; } .legend .crit{ background:#e53935; }
.small-mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px; }
.select-row{ display:flex; gap:.5rem; flex-wrap:wrap; align-items: end; }
.select-row select{ min-width: 140px; }
.badge-probe{ font-size: 12px; padding: 2px 6px; border-radius: 6px; background:#eef; }
</style>
<script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-lg-8">
    <div id="cy"></div>
    <div class="mt-2 small">
      <span class="legend"><span class="ok"></span> &lt;=60%</span> ·
      <span class="legend"><span class="warn"></span> 60–90%</span> ·
      <span class="legend"><span class="crit"></span> &gt;90%</span>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Unifilar</h6>
        <input type="datetime-local" id="ts" class="form-control form-control-sm" style="width: 210px;">
      </div>
      <small class="text-muted mb-2">La hora se aplica a todos los tags como <b>instantánea</b>.</small>

      <textarea id="cfg" class="form-control small-mono" rows="14" spellcheck="false">{
  "buses":[{"name":"B1"},{"name":"B2"}],
  "lines":[{"name":"L12","bus0":"B1","bus1":"B2","s_nom":10.0,"r_per_length":0.3,"x_per_length":0.9,"length_km":5.0}],
  "loads":[{"name":"LD1","bus":"B1","p_mw":1.0,"q_mvar":0.2}],
  "generators":[{"name":"G1","bus":"B2","p_set_mw":0.8,"v_set_pu":1.02,"p_max_mw":3.0,"control":"PV"}]
}</textarea>

      <div class="mt-2">
        <button class="btn btn-primary btn-sm" id="btn-calcular">Calcular flujo</button>
        <button class="btn btn-outline-secondary btn-sm" id="btn-mapeo">Mapear tags</button>
      </div>

      <div id="mapbox" class="mt-3"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// --- helpers REST ---
async function getJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function postJSON(url, body){ const r = await fetch(url,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)}); const j = await r.json(); if(!r.ok || j.ok===false) throw new Error(j.error||"Error"); return j; }
const api = {
  groups: ()=> getJSON("{{ url_for('power.tag_groups') }}"),
  equipment: (grp)=> getJSON(`{{ url_for('power.tag_equipment') }}?grp=${encodeURIComponent(grp)}`),
  ids: (grp, eq)=> getJSON(`{{ url_for('power.tag_ids') }}?grp=${encodeURIComponent(grp)}&equipment=${encodeURIComponent(eq)}`),
  probe: (p)=> postJSON("{{ url_for('power.probe_tag') }}", p),
  pf: (cfg)=> postJSON("{{ url_for('power.unifilar_build') }}", cfg),
};

// --- grafo ---
let cy = cytoscape({
  container: document.getElementById('cy'),
  style: [
    { selector: 'node', style: { 'label': 'data(label)', 'text-valign':'center', 'background-color':'#90caf9', 'shape':'round-rectangle', 'width':'label', 'padding':'8px' } },
    { selector: 'edge[type="line"]', style: { 'width': 3, 'line-color': '#78909c', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#78909c', 'curve-style':'bezier', 'label':'data(label)' } },
    { selector: 'edge[type="trafo"]', style: { 'width': 3, 'line-style':'dashed', 'line-color': '#8e24aa', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#8e24aa' } },
    { selector: 'edge[severity = "warn"]', style: {'line-color':'#ff9800','target-arrow-color':'#ff9800'} },
    { selector: 'edge[severity = "crit"]', style: {'line-color':'#e53935','target-arrow-color':'#e53935'} },
  ],
  layout: { name: 'breadthfirst', directed: true, padding: 20 }
});

function drawGraph(graph){
  const nodes = (graph.nodes||[]).map(n=>({ data: n.data }));
  const edges = (graph.edges||[]).map(e=>({ data: e.data }));
  cy.elements().remove();
  cy.add(nodes).add(edges);
  cy.layout({ name:'breadthfirst', directed:true, padding:20, spacingFactor:1.2 }).run();
}

// --- mapeo de tags (UI mínima) ---
function makeSelectorRow(prefix, field, scaleDefault){
  const row = document.createElement('div'); row.className='select-row';
  row.innerHTML = `
    <div><label class="form-label small">Grupo</label><select id="${prefix}_grp" class="form-select form-select-sm"></select></div>
    <div><label class="form-label small">Equipo</label><select id="${prefix}_eq" class="form-select form-select-sm"></select></div>
    <div><label class="form-label small">ID</label><select id="${prefix}_id" class="form-select form-select-sm"></select></div>
    <div><label class="form-label small">scale</label><input id="${prefix}_sc" type="number" step="0.001" class="form-control form-control-sm" value="${scaleDefault||1}"></div>
    <div><button class="btn btn-sm btn-outline-secondary" id="${prefix}_probe" type="button">Probar</button> <span class="badge-probe" id="${prefix}_result"></span></div>
  `;
  (async ()=>{
    const grpSel = row.querySelector(`#${prefix}_grp`);
    const eqSel  = row.querySelector(`#${prefix}_eq`);
    const idSel  = row.querySelector(`#${prefix}_id`);
    const res    = row.querySelector(`#${prefix}_result`);
    const probe  = row.querySelector(`#${prefix}_probe`);
    const groups = await api.groups(); grpSel.innerHTML = groups.map(g=>`<option>${g}</option>`).join('');
    async function updateEq(){ const eqs = await api.equipment(grpSel.value); eqSel.innerHTML = eqs.map(e=>`<option>${e}</option>`).join(''); await updateId(); }
    async function updateId(){ const ids = await api.ids(grpSel.value, eqSel.value); idSel.innerHTML = ids.map(id=>`<option>${id}</option>`).join(''); }
    grpSel.onchange=updateEq; eqSel.onchange=updateId; await updateEq();
    probe.onclick = async ()=>{
      try{
        const s = { equip_grp: grpSel.value, equipment: eqSel.value, signal_id: idSel.value, scale: Number(row.querySelector(`#${prefix}_sc`).value||1) };
        const ts = document.getElementById('ts').value;   // ⬅️ NUEVO
        if (ts) s.timestamp = ts;                         // ⬅️ NUEVO
        const r = await api.probe(s);
        res.textContent = r.value.toFixed(3);
      }catch(e){ res.textContent = 'error'; }
    };
  })();
  row.getValue = ()=>({
    field,
    source: {
      equip_grp: row.querySelector(`#${prefix}_grp`).value,
      equipment: row.querySelector(`#${prefix}_eq`).value,
      signal_id: row.querySelector(`#${prefix}_id`).value,
      scale: Number(row.querySelector(`#${prefix}_sc`).value||1)
    }
  });
  return row;
}

document.getElementById("btn-mapeo").onclick = async ()=>{
  const cfg = JSON.parse(document.getElementById('cfg').value);
  const form = document.getElementById('mapbox'); form.innerHTML = '';
  function section(title){ const h = document.createElement('h6'); h.textContent=title; form.appendChild(h); }
  function attach(box, obj, row){
    box.appendChild(row);
    const get = row.getValue;
    box.getSources = ()=>{ const s = get(); obj.sources = obj.sources || {}; obj.sources[s.field] = s.source; };
  }
  section('Cargas');
  (cfg.loads||[]).forEach((ld,i)=>{
    const box=document.createElement('div'); box.className='border rounded p-2 mb-2'; box.innerHTML = `<b>${ld.name}</b> <small class="text-muted">(${ld.bus})</small>`;
    attach(box, ld, makeSelectorRow(`ld${i}_p`,'p_mw','0.001'));
    attach(box, ld, makeSelectorRow(`ld${i}_q`,'q_mvar','0.001'));
    form.appendChild(box);
  });
  section('Generadores');
  (cfg.generators||[]).forEach((g,i)=>{
    const box=document.createElement('div'); box.className='border rounded p-2 mb-2'; box.innerHTML = `<b>${g.name}</b> <small class="text-muted">(${g.bus})</small>`;
    attach(box, g, makeSelectorRow(`g${i}_p`,'p_set_mw','0.001'));
    attach(box, g, makeSelectorRow(`g${i}_v`,'v_set_pu','0.01'));
    form.appendChild(box);
  });
  const saveBtn = document.createElement('button'); saveBtn.className='btn btn-sm btn-success'; saveBtn.textContent='Aplicar mapeo al JSON';
  saveBtn.onclick = ()=>{ [...form.querySelectorAll('.border')].forEach(b=>b.getSources&&b.getSources()); document.getElementById('cfg').value = JSON.stringify(cfg,null,2); };
  form.appendChild(saveBtn);
};

document.getElementById("btn-calcular").onclick = async ()=>{
  try{
    const cfg = JSON.parse(document.getElementById('cfg').value);
    const tsInput = document.getElementById('ts').value;
    if (tsInput) cfg.timestamp = tsInput; // snapshot global
    const r = await api.pf(cfg);
    drawGraph(r.graph||{nodes:[],edges:[]});
  }catch(e){ alert(e.message||e); }
};
</script>
{% endblock %}
