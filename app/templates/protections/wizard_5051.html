{% extends "base.html" %}
{% block title %}Wizard 50/51{% endblock %}

{% block extra_head %}
<style>
  .grid{display:grid;grid-template-columns: 420px 1fr; gap:16px}
  .card{border:1px solid #e9ecef; border-radius:12px; padding:12px}
  .small-mono{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px}
  .row-g{display:grid; grid-template-columns:1fr 1fr; gap:8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
{% endblock %}

{% block content %}
<h4 class="mb-2">Wizard 50/51</h4>
<div class="grid">
  <!-- Lado izquierdo: entradas -->
  <div class="card">
    <h6 class="mb-2">1) Corriente (tag)</h6>
    <div class="row-g">
      <div>
        <label class="form-label">Grupo</label>
        <select id="i_grp" class="form-select form-select-sm"></select>
      </div>
      <div>
        <label class="form-label">Equipo</label>
        <select id="i_eq" class="form-select form-select-sm"></select>
      </div>
      <div class="col-2">
        <label class="form-label">ID</label>
        <select id="i_id" class="form-select form-select-sm"></select>
      </div>
      <div>
        <label class="form-label">Ventana (d√≠as)</label>
        <input id="days" type="number" class="form-control form-control-sm" value="30" min="1">
      </div>
    </div>
    <div class="d-flex align-items-end gap-2 mt-2">
      <div>
        <label class="form-label">Instant√°nea (opcional)</label>
        <input id="ts" type="datetime-local" class="form-control form-control-sm" style="width:220px">
      </div>
      <button id="btn-probe" class="btn btn-outline-secondary btn-sm">Probar</button>
      <span id="probe-out" class="small-mono"></span>
    </div>

    <hr>

    <h6 class="mb-2">2) Red / l√≠nea</h6>
    <div class="row-g">
      <div>
        <label class="form-label">V (kV)</label>
        <input id="V_kV" type="number" step="0.1" class="form-control form-control-sm" value="13.2">
      </div>
      <div>
        <label class="form-label">pf</label>
        <input id="pf" type="number" step="0.01" class="form-control form-control-sm" value="0.95">
      </div>
      <div>
        <label class="form-label">R (Œ©/km)</label>
        <input id="r_km" type="number" step="0.001" class="form-control form-control-sm" value="0.3">
      </div>
      <div>
        <label class="form-label">X (Œ©/km)</label>
        <input id="x_km" type="number" step="0.001" class="form-control form-control-sm" value="0.9">
      </div>
      <div>
        <label class="form-label">Longitud (km)</label>
        <input id="L_km" type="number" step="0.01" class="form-control form-control-sm" placeholder="Si no, medir ZIP">
      </div>
      <div>
        <label class="form-label">Fracci√≥n hasta falla</label>
        <input id="frac" type="number" step="0.01" class="form-control form-control-sm" value="0.5" min="0" max="1">
      </div>
    </div>

    <div class="mt-2">
      <div class="small text-muted mb-1">Detectar l√≠nea desde SHP.zip (igual que el mapa):</div>
      <div class="row-g">
        <input id="zip_path" class="form-control form-control-sm" value="{{ default_zip }}" readonly>
        <input id="zip_attr" class="form-control form-control-sm" value="LINEA_ID">
      </div>

      <div class="d-flex align-items-end gap-2 mt-2">
        <input id="zip_query" class="form-control form-control-sm" placeholder="Buscar ID (ej: AU11)" style="max-width:220px">
        <button id="btn-search" class="btn btn-outline-secondary btn-sm">Buscar</button>
        <select id="zip_id" class="form-select form-select-sm" size="6" style="max-width:420px"></select>
        <input id="zip_mat_attr" class="form-control form-control-sm" placeholder="campo MATERIAL (opcional)" value="MATERIAL" style="max-width:220px">
        <button id="btn-profile" class="btn btn-outline-secondary btn-sm">Calcular perfil</button>
      </div>
      <div class="small-mono mt-1" id="ids-info"></div>
      <div class="small-mono mt-2" id="measure-out"></div>
      <div class="mt-2" id="mat-table"></div>
    </div>

    <hr>

    <h6 class="mb-2">3) Curva y objetivo</h6>
    <div class="row-g">
      <div>
        <label class="form-label">Curva IEC</label>
        <select id="curve" class="form-select form-select-sm">
          <option value="standard">Standard</option>
          <option value="very">Very</option>
          <option value="extremely">Extremely</option>
          <option value="long">Long</option>
        </select>
      </div>
      <div>
        <label class="form-label">t<sub>objetivo</sub> (s) a I<sub>cc</sub></label>
        <input id="t_target" type="number" step="0.01" class="form-control form-control-sm" value="0.4">
      </div>
      <div>
        <label class="form-label">Factor Is ¬∑ I<sub>p95</sub></label>
        <input id="is_factor" type="number" step="0.01" class="form-control form-control-sm" value="1.2">
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="btn-calc" class="btn btn-primary btn-sm">Calcular ajustes</button>
      <button id="btn-export" class="btn btn-outline-secondary btn-sm">Exportar JSON</button>
    </div>
  </div>

  <!-- Lado derecho: resultados -->
  <div class="card">
    <h6 class="mb-2">Resultados</h6>
    <div id="out-json" class="small-mono" style="max-height:200px; overflow:auto"></div>
    <hr>
    <canvas id="chart" height="180"></canvas>
    <div class="small text-muted mt-2">
      La curva IDMT se traza con los ajustes calculados. Se marca I<sub>cc</sub>.
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* ==== helpers ==== */
async function getJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function postJSON(url, body){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const j=await r.json(); if(!r.ok||j.ok===false) throw new Error(j.error||'Error'); return j; }

const api = {
  groups: ()=> getJSON("{{ url_for('power.tag_groups') }}"),
  eqs: (g)=> getJSON(`{{ url_for('power.tag_equipment') }}?grp=${encodeURIComponent(g)}`),
  ids: (g,e)=> getJSON(`{{ url_for('power.tag_ids') }}?grp=${encodeURIComponent(g)}&equipment=${encodeURIComponent(e)}`),
  probe: (p)=> postJSON("{{ url_for('power.probe_tag') }}", p),
  propose: (body)=> postJSON("{{ url_for('protections.propose_5051') }}", body),
  suggest: (body)=> postJSON("{{ url_for('protections.suggest') }}", body),
};

// üîß Referencias DOM expl√≠citas (evita depender de id ‚Üí window.var)
const i_grp = document.getElementById('i_grp');
const i_eq  = document.getElementById('i_eq');
const i_id  = document.getElementById('i_id');

/* ==== combos de corriente ==== */
(async ()=>{
  const groups = await api.groups();
  i_grp.innerHTML = groups.map(g=>`<option>${g}</option>`).join('');
  async function upEq(){ const eqs = await api.eqs(i_grp.value); i_eq.innerHTML = eqs.map(e=>`<option>${e}</option>`).join(''); await upId(); }
  async function upId(){ const ids = await api.ids(i_grp.value, i_eq.value); i_id.innerHTML = ids.map(i=>`<option>${i}</option>`).join(''); }
  i_grp.onchange=upEq; i_eq.onchange=upId; await upEq();
})();

/* ==== Probar valor corriente (snapshot opcional) ==== */
document.getElementById('btn-probe').onclick = async ()=>{
  const s = { equip_grp: i_grp.value, equipment: i_eq.value, signal_id: i_id.value, scale: 1 };
  const ts = document.getElementById('ts').value; if(ts) s.timestamp = ts;
  try{
    const r = await api.probe(s);
    document.getElementById('probe-out').textContent = `I‚âà ${Number(r.value).toFixed(2)} A`;
  }catch(e){ document.getElementById('probe-out').textContent = 'sin datos'; }
};

/* ==== ZIP: b√∫squeda con l√≠mite + perfil ==== */
const api2 = {
  lineSuggest: (zip_path, attr, q, limit=50) =>
    fetch(`{{ url_for('protections.zip_line_ids') }}?zip_path=${encodeURIComponent(zip_path)}&attr=${encodeURIComponent(attr||'')}&q=${encodeURIComponent(q||'')}&limit=${limit}`)
      .then(r=>r.json()),
  lineProfile: (body)=> postJSON("{{ url_for('protections.zip_line_profile') }}", body),
  feederProfile: (body)=> postJSON("{{ url_for('protections.feeder_profile') }}", body),
};

const idsInfo = document.getElementById('ids-info');
const selIds  = document.getElementById('zip_id');
const inQuery = document.getElementById('zip_query');

async function loadIds(qText){
  const zip_path = document.getElementById('zip_path').value.trim();
  const zip_attr = (document.getElementById('zip_attr').value || '').trim(); // puede ir vac√≠o
  selIds.innerHTML = '';
  idsInfo.textContent = 'Buscando...';
  const j = await api2.lineSuggest(zip_path, zip_attr, qText, 50);
  if(!j.ok){ idsInfo.textContent = j.error || 'Error'; return; }
  // Mostrar el campo realmente usado (autodetectado en backend si hace falta)
  document.getElementById('zip_attr').value = j.attr || document.getElementById('zip_attr').value;

  selIds.innerHTML = (j.items||[]).map(v=>`<option value="${v}">${v}</option>`).join('');
  idsInfo.textContent = `Campo: ${j.attr} ¬∑ ${j.items?.length||0} resultados${j.truncated ? ' (primeros 50)' : ''}`;

  // Si hay 1 resultado, lo dejamos seleccionado
  if((j.items||[]).length === 1){ selIds.selectedIndex = 0; }
}

// Bot√≥n Buscar
document.getElementById('btn-search').onclick = ()=> loadIds(inQuery.value);

// Typeahead con debounce
let tmr = null;
inQuery.addEventListener('input', ()=>{
  clearTimeout(tmr);
  tmr = setTimeout(()=> loadIds(inQuery.value), 300);
});

// Al abrir, buscar por el valor del Equipo (p.ej. AU11)
(function autoSearchByEquipo(){
  const eqVal = (document.getElementById('i_eq').value || '').toString();
  if(eqVal){ inQuery.value = eqVal; loadIds(eqVal); }
})();




document.getElementById('btn-profile').onclick = async ()=>{
  const zip_path = document.getElementById('zip_path').value.trim();
  const attr     = (document.getElementById('zip_attr').value || '').trim();
  const value    = document.getElementById('zip_id').value;   // puede venir vac√≠o
  const mat_attr = (document.getElementById('zip_mat_attr').value || '').trim();
  const out  = document.getElementById('measure-out');
  const tableBox = document.getElementById('mat-table');
  tableBox.innerHTML = '';

  out.textContent = 'Calculando perfil...';

  try{
    let prof;
    if (value) {
      // Perfil por ID √∫nico
      prof = await api2.lineProfile({ zip_path, attr, value, material_attr: mat_attr || null });
    } else {
      // üîß Fallback: perfil por GRUPO/EQUIPO (igual que el mapa)
      const group = document.getElementById('i_grp').value;
      const equipment = document.getElementById('i_eq').value;
      prof = await api2.feederProfile({ zip_path, group, equipment, material_attr: mat_attr || null });
    }
    if(!prof.ok){ out.textContent = prof.error || 'Error'; return; }

    const L = prof.length_km || 0;
    document.getElementById('L_km').value = L.toFixed(3);
    const used = prof.used_fields ? ` ¬∑ campos usados: ${prof.used_fields.group} / ${prof.used_fields.feeder}` : '';
    const segs = prof.segments!=null ? ` ¬∑ tramos: ${prof.segments}` : '';
    out.textContent = `L=${L.toFixed(3)} km${used}${segs}`;

    if((prof.materials||[]).length){
      const rows = prof.materials.map(m=>`
        <tr><td>${m.material}</td><td class="text-end">${(m.length_km||0).toFixed(3)}</td><td class="text-end">${(m.percent||0).toFixed(1)}%</td></tr>
      `).join('');
      tableBox.innerHTML = `
        <div class="card mt-2 p-2">
          <strong>Composici√≥n de materiales</strong>
          <div class="table-responsive mt-2">
            <table class="table table-sm mb-0">
              <thead><tr><th>Material</th><th class="text-end">Longitud (km)</th><th class="text-end">%</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;
    }
  }catch(e){
    out.textContent = 'No se pudo calcular perfil';
  }
};

/* ==== Calcular ajustes ==== */
let chart;
document.getElementById('btn-calc').onclick = async ()=>{
  const current_tag = { equip_grp: i_grp.value, equipment: i_eq.value, signal_id: i_id.value };
  const days = Number(document.getElementById('days').value||30);
  const V_kV = Number(document.getElementById('V_kV').value||0);
  const pf = Number(document.getElementById('pf').value||0.95);
  const r_ohm_km = Number(document.getElementById('r_km').value||0.3);
  const x_ohm_km = Number(document.getElementById('x_km').value||0.9);
  const length_km = document.getElementById('L_km').value ? Number(document.getElementById('L_km').value) : null;
  const frac = Number(document.getElementById('frac').value||0.5);
  const curve = document.getElementById('curve').value;
  const t_target = Number(document.getElementById('t_target').value||0.4);
  const is_factor = Number(document.getElementById('is_factor').value||1.2);

  const r1 = await api.propose({ current_tag, days });

  const suggestBody = {
    V_kV, pf, is_factor, curve, t_target,
    tag: current_tag,
    Zs: { r: 0.2, x: 0.8 },
    fraction: frac,
    line: { r_ohm_km, x_ohm_km, length_km },
  };

  // üîß usar zip_id (no zip_value)
  const zip_path = document.getElementById('zip_path').value.trim();
  const zip_attr = document.getElementById('zip_attr').value.trim();
  const zip_id   = document.getElementById('zip_id').value;
  if(zip_path && zip_attr && zip_id){
    suggestBody.shape = { zip_path, attr: zip_attr, value: zip_id };
  }

  const r2 = await api.suggest(suggestBody);

  const I51 = r1?.suggestions?.["51P"]?.pickup_A ?? r2?.Is_A;
  const I50 = r1?.suggestions?.["50P"]?.pickup_A ?? (I51? 6*I51 : null);
  const Is  = r2?.Is_A ?? I51;
  const TMS = r2?.TMS ?? 0.2;
  const Icc = r2?.I_f_A ?? null;

  const out = {
    inputs:{
      current_tag, days, V_kV, pf, r_ohm_km, x_ohm_km,
      length_km: r2?.length_km ?? length_km, fraction: frac,
      curve, t_target, is_factor
    },
    suggestions:{
      "51P": { pickup_A: round(I51,2), curve, TMS: round(TMS,3) },
      "50P": { pickup_A: I50? round(I50,1) : null },
      meta:{ Is_A: round(Is,2), Icc_A: Icc? Math.round(Icc) : null }
    }
  };
  document.getElementById('out-json').textContent = JSON.stringify(out,null,2);
  drawCurve({Is: Is||I51||1, TMS: TMS||0.2, curve, Icc});
};

function round(x,n){ return (x==null)? null : Number(x.toFixed(n)); }

/* ==== Curva IDMT (front) ==== */
function kAlpha(curve){
  const map = { standard:{k:0.14, a:0.02}, very:{k:13.5, a:1.0}, extremely:{k:80, a:2}, long:{k:120, a:1} };
  return map[curve] || map.standard;
}
function idmt_t(I, Is, TMS, curve){
  const {k,a} = kAlpha(curve); const M = Math.max(I/Math.max(Is,1e-9), 1.0000001);
  return TMS * (k / (Math.pow(M,a)-1.0));
}
function drawCurve({Is, TMS, curve, Icc}){
  const Imax = Math.max(Icc? Icc*1.3 : Is*20, Is*6);
  const xs=[]; const ys=[];
  for(let I=Is*1.05; I<=Imax; I*=1.05){ xs.push(I); ys.push(idmt_t(I,Is,TMS,curve)); }
  const data = {
    datasets: [
      { label: 'IDMT', data: xs.map((x,i)=>({x, y:ys[i]})), showLine:true, pointRadius:0 },
      ...(Icc? [{ label:'Icc', data:[{x:Icc,y:0},{x:Icc,y:Math.max(...ys)}], showLine:true, pointRadius:0 }] : [])
    ]
  };
  const ctx = document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'scatter',
    data,
    options:{
      scales:{ x:{ type:'logarithmic', title:{display:true,text:'Corriente [A]'} },
               y:{ type:'logarithmic', title:{display:true,text:'Tiempo [s]'} } },
      plugins:{ legend:{display:true} },
      animation:false
    }
  });
}

/* ==== Exportar JSON ==== */
document.getElementById('btn-export').onclick = ()=>{
  const txt = document.getElementById('out-json').textContent || '{}';
  const blob = new Blob([txt], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ajustes_5051_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
};
</script>
{% endblock %}
