{% extends "base.html" %}
{% block title %}Mapa de Red{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<div class="container my-3">
  <h3 class="mb-3">Mapa de Red — {{ equip_grp }} / {{ equipment }}</h3>
  <div id="map" style="width:100%; height: 720px; border-radius: 10px;"></div>
  <a href="{{ url_for('analizador.index') }}" class="btn btn-secondary mt-3">Volver</a>
</div>

<script>
const ZIP_URL = "{{ zip_url }}";
const EQUIP = "{{ equipment }}".toLowerCase();

const map = L.map('map', { zoomControl: true }).setView([-34.6, -58.4], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

function getProp(p, keys) {
  for (const k of keys) if (p && (k in p)) return p[k];
  return '';
}

function popupHtml(p) {
  const tens = getProp(p, ['Tensión n','TensiÃ³n n']);
  return `
    <b>Alimentado:</b> ${getProp(p, ['Alimentado'])}<br>
    <b>Equipo:</b> {{ equip_grp }} [{{ equipment }}]<br>
    <b>Tensión nominal:</b> ${tens || ''} kV<br>
    <b>Material:</b> ${getProp(p, ['Material'])}<br>
    <b>Tipo:</b> ${getProp(p, ['Tipo'])}<br>
  `;
}

function estilo() { return { color: '#3388ff', weight: 3, opacity: 0.9 }; }

shp(ZIP_URL).then(function(geojson) {
  // geojson puede venir como FeatureCollection o como múltiples capas
  const features = (geojson && geojson.features) ? geojson.features : [];
  // Filtrar por 'Alimentado' que contenga el texto de equipment
  const filtradas = features.filter(f => {
    const a = getProp(f.properties, ['Alimentado']);
    return (a && a.toString().toLowerCase().includes(EQUIP));
  });

  if (!filtradas.length) {
    alert("No hay geometrías para ese equipo/línea en el shapefile.");
    return;
  }

  const capa = L.geoJSON({ type: 'FeatureCollection', features: filtradas }, {
    style: estilo,
    onEachFeature: function (feature, layer) {
      const p = feature.properties || {};
      const label = p['Etiqueta'] || p['Alimentado'] || '';
      layer.bindTooltip(label);
      layer.bindPopup(popupHtml(p), { maxWidth: 280 });
    }
  }).addTo(map);

  try { map.fitBounds(capa.getBounds(), { padding: [20,20] }); }
  catch(e) { /* si algo falla, queda el center por defecto */ }
}).catch(err => {
  console.error(err);
  alert("No se pudo leer el shapefile (red_electrica.zip). Verificá ubicación o formato.");
});
</script>
{% endblock %}
